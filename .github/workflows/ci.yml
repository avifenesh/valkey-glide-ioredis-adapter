name: CI

on:
  push:
    branches: [ main, develop ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, develop ]

# Cancel previous runs on the same PR/branch
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  test-linux-standalone:
    name: Linux Standalone Tests (Node ${{ matrix.node }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: ['22']

    services:
      valkey-bundle:
        image: valkey/valkey-bundle:8.1-bookworm
        ports:
          - 6383:6379
        options: >-
          --health-cmd "valkey-cli -p 6379 ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --memory=2g
          --cpus=2
          --ulimit nofile=65536:65536

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup Node.js ${{ matrix.node }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build

    - name: Wait for Valkey Bundle and verify modules
      run: |
        echo "Waiting for Valkey Bundle with modules..."
        # Install valkey-cli for testing
        sudo apt-get update && sudo apt-get install -y valkey-tools
        
        for i in {1..30}; do
          if valkey-cli -h 127.0.0.1 -p 6383 ping > /dev/null 2>&1; then
            echo "âœ… Valkey Bundle is ready!"
            echo "ðŸ“¦ Checking loaded modules..."
            valkey-cli -h 127.0.0.1 -p 6383 MODULE LIST | grep -E "(json|search)" || echo "âš ï¸  Modules not loaded or command not available"
            echo "ðŸ” Testing JSON command..."
            valkey-cli -h 127.0.0.1 -p 6383 JSON.SET test_ci_key '$' '"test"' || echo "âš ï¸  JSON module not available"
            # Skipping Search module verification in CI
            echo "â„¹ï¸ Skipping Search module verification in CI"
            
            echo "ðŸ”§ Configuring Valkey for testing..."
            # Optimize Valkey for testing
            valkey-cli -h localhost -p 6383 CONFIG SET maxmemory-policy allkeys-lru
            valkey-cli -h localhost -p 6383 CONFIG SET tcp-keepalive 60
            valkey-cli -h localhost -p 6383 CONFIG SET timeout 300
            valkey-cli -h localhost -p 6383 CONFIG SET save ""
            echo "âœ… Valkey configured for testing"
            break
          fi
          echo "â³ Waiting for Valkey Bundle... ($i/30)"
          sleep 2
        done

    - name: Run standalone tests deterministically (sequential)
      run: |
        echo "ðŸ” Checking Valkey health before tests..."
        for i in {1..10}; do
          if valkey-cli -p 6383 ping > /dev/null 2>&1; then
            echo "âœ… Valkey is healthy"
            break
          else
            echo "âš ï¸ Valkey not ready, waiting... ($i/10)"
            sleep 3
          fi
        done
        
        echo "ðŸ§ª Running unit tests..."
        timeout 300 npm run test:standalone -- tests/unit/ || {
          echo "âš ï¸ Unit tests timed out or failed, forcing cleanup..."
          node -e "import('./dist/index.js').then(pkg => pkg.default.forceCloseAllClients(1000)).catch(() => {})"
          exit 1
        }
        
        echo "â³ Waiting 10s to reduce server load..."
        sleep 10
        
        echo "ðŸ” Checking Valkey health before integration tests..."
        for i in {1..5}; do
          if valkey-cli -p 6383 ping > /dev/null 2>&1; then
            echo "âœ… Valkey is healthy"
            break
          else
            echo "âš ï¸ Valkey not ready, waiting... ($i/5)"
            sleep 3
          fi
        done
        
        echo "ðŸ§ª Running integration tests..."
        timeout 300 npm run test:standalone -- tests/integration/ || {
          echo "âš ï¸ Integration tests timed out or failed, forcing cleanup..."
          node -e "import('./dist/index.js').then(pkg => pkg.default.forceCloseAllClients(1000)).catch(() => {})"
          exit 1
        }
        
        echo "â³ Waiting 10s to reduce server load..."
        sleep 10
        
        echo "ðŸ” Checking Valkey health before cluster tests..."
        for i in {1..5}; do
          if valkey-cli -p 6383 ping > /dev/null 2>&1; then
            echo "âœ… Valkey is healthy"
            break
          else
            echo "âš ï¸ Valkey not ready, waiting... ($i/5)"
            sleep 3
          fi
        done
        
        echo "ðŸ§ª Running tests sequentially to reduce pressure..."
        DISABLE_CLUSTER_TESTS=true \
        TEST_TIMEOUT_SECONDS=480 \
        NODE_OPTIONS="--max-old-space-size=2048" \
        ./scripts/test-sequential.sh
      env:
        CI: true
        VALKEY_HOST: 127.0.0.1
        VALKEY_PORT: 6383
        ADAPTER_DIAG_HANDLES: 0
        ADAPTER_CONNECT_TIMEOUT_MS: 4000
        ADAPTER_LAZY_CONNECT: 1

  test-linux-cluster:
    name: Linux Cluster Tests (Node ${{ matrix.node }})
    runs-on: ubuntu-latest
    needs: test-linux-standalone
    strategy:
      matrix:
        node: ['22']

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup Node.js ${{ matrix.node }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build

    - name: Install Valkey server and start cluster
      run: |
        sudo apt-get update && sudo apt-get install -y valkey-server valkey-tools
        ./scripts/start-test-cluster.sh
        echo "â³ Waiting for cluster nodes to accept connections..."
        for i in {1..20}; do
          if nc -z 127.0.0.1 17000 && nc -z 127.0.0.1 17001 && nc -z 127.0.0.1 17002; then
            echo "âœ… Cluster ports are open"; break; fi
          echo "â³ Still waiting for cluster... ($i/20)"; sleep 2
        done

    - name: Run cluster tests sequentially
      run: |
        echo "ðŸ§ª Running cluster tests sequentially (low pressure)"
        ENABLE_CLUSTER_TESTS=true DISABLE_STANDALONE_TESTS=true \
        VALKEY_CLUSTER_NODES=127.0.0.1:17000,127.0.0.1:17001,127.0.0.1:17002 \
        TEST_TIMEOUT_SECONDS=600 \
        NODE_OPTIONS="--max-old-space-size=2048" \
        ./scripts/test-sequential.sh || {
          echo "âš ï¸ Cluster tests failed, forcing cleanup...";
          node -e "import('./dist/index.js').then(pkg => pkg.default.forceCloseAllClients(1000)).catch(() => {})"; exit 1; }
      env:
        CI: true
        ADAPTER_CONNECT_TIMEOUT_MS: 4000
        ADAPTER_LAZY_CONNECT: 1

    - name: Cleanup cluster
      if: always()
      run: ./scripts/stop-test-cluster.sh || true

    - name: Cleanup after tests
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up after tests..."
        # Force close all Redis clients
        node -e "import('./dist/index.js').then(pkg => pkg.default.forceCloseAllClients(1000)).catch(() => {})" || true
        sleep 2
        echo "âœ… Cleanup completed"

    - name: Upload coverage to Codecov
      if: matrix.node == '20'
      uses: codecov/codecov-action@v5
      with:
        files: ./coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  test-macos:
    name: Test on macOS with Valkey (core functionality, no modules)
    runs-on: macos-latest
    strategy:
      matrix:
        node: ['22']

    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup Node.js ${{ matrix.node }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node }}
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project
      run: npm run build

    - name: Install and start Valkey server
      run: |
        echo "ðŸ”‘ Installing Valkey server via Homebrew..."
        
        # Install Valkey directly (available in main Homebrew formulae)
        brew install valkey
        
        # Start Valkey server with custom config suitable for testing
        valkey-server --daemonize yes \
          --port 6383 \
          --bind 127.0.0.1 \
          --save "" \
          --appendonly no \
          --maxmemory 256mb \
          --maxmemory-policy allkeys-lru \
          --loglevel notice

    - name: Wait for Valkey server
      run: |
        echo "â³ Waiting for Valkey server to be ready..."
        
        for i in {1..20}; do
          if valkey-cli -p 6383 ping > /dev/null 2>&1; then
            echo "âœ… Valkey server is ready!"
            echo "ðŸ“‹ Server info:"
            valkey-cli -p 6383 INFO server | head -5
            break
          fi
          echo "â³ Still waiting for Valkey server... ($i/20)"
          sleep 2
        done
        
        # Final test
        valkey-cli -p 6383 ping

    - name: Run tests sequentially on macOS (no JSON/module tests)
      run: |
        echo "ðŸ§ª Running tests on macOS (no JSON/module support)"
        # Health check Valkey before tests
        echo "ðŸ” Checking Valkey health..."
        for i in {1..10}; do
          if valkey-cli -p 6383 ping > /dev/null 2>&1; then
            echo "âœ… Valkey is healthy"
            break
          else
            echo "âš ï¸ Valkey not ready, waiting... ($i/10)"
            sleep 3
          fi
        done
        
        echo "ðŸ§ª Running unit tests (excluding JSON/module tests)..."
        # Exclude JSON and module-dependent tests
        # Use a background process with timeout for macOS
        (find tests/unit -name "*.test.mjs" ! -name "*json*" ! -name "*module*" ! -name "*search*" | xargs npm run test:standalone --) &
        TEST_PID=$!
        (sleep 300 && kill $TEST_PID 2>/dev/null) &
        TIMEOUT_PID=$!
        wait $TEST_PID
        TEST_EXIT_CODE=$?
        kill $TIMEOUT_PID 2>/dev/null
        
        if [ $TEST_EXIT_CODE -ne 0 ]; then
          echo "âš ï¸ Unit tests failed, forcing cleanup..."
          node -e "import('./dist/index.js').then(pkg => pkg.default.forceCloseAllClients(1000)).catch(() => {})"
          exit 1
        fi
        
        echo "â³ Waiting 15s to reduce server load..."
        sleep 15
        
        echo "ðŸ” Checking Valkey health before integration tests..."
        for i in {1..5}; do
          if valkey-cli -p 6383 ping > /dev/null 2>&1; then
            echo "âœ… Valkey is healthy"
            break
          else
            echo "âš ï¸ Valkey not ready, waiting... ($i/5)"
            sleep 3
          fi
        done
        
        echo "ðŸ§ª Running basic integration tests..."
        # Use a background process with timeout for macOS
        (npm run test:standalone -- tests/integration/simple-adapter.test.mjs tests/integration/fastify-redis.test.mjs) &
        TEST_PID=$!
        (sleep 300 && kill $TEST_PID 2>/dev/null) &
        TIMEOUT_PID=$!
        wait $TEST_PID
        TEST_EXIT_CODE=$?
        kill $TIMEOUT_PID 2>/dev/null
        
        if [ $TEST_EXIT_CODE -ne 0 ]; then
          echo "âš ï¸ Integration tests failed, forcing cleanup..."
          node -e "import('./dist/index.js').then(pkg => pkg.default.forceCloseAllClients(1000)).catch(() => {})"
          exit 1
        fi
      env:
        CI: true
        VALKEY_HOST: 127.0.0.1
        VALKEY_PORT: 6383
        SKIP_MODULE_TESTS: true

    - name: Cleanup Valkey server
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up Valkey server..."
        
        # Force close all Redis clients first
        echo "ðŸ”Œ Force closing all Redis clients..."
        node -e "import('./dist/index.js').then(pkg => pkg.default.forceCloseAllClients(1000)).catch(() => {})" || true
        
        # Wait for cleanup
        sleep 2
        
        # Stop Valkey gracefully with timeout
        timeout 10 valkey-cli -p 6383 SHUTDOWN NOSAVE || true
        # Kill any remaining processes
        pkill valkey-server || true
        # Wait a moment for cleanup
        sleep 2
        echo "âœ… Valkey cleanup completed"

  # Note: Full module testing happens on Linux, coverage upload is handled there

  lint:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v5

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Run ESLint
      run: npm run lint

    - name: Run TypeScript check
      run: npm run build
